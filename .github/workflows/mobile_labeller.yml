name: Mobile Templated Discussions

on:
  discussion:
    types: [created]

jobs:
  label-mobile-discussion:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.discussion.category.name, 'Mobile') }}

    steps:
      - name: Get selected mobile feature area
        id: get_selected_feature_area
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            try {
              const body = context.payload.discussion.body;
              if (!body) return "";

              const lines = body.split(/\r?\n/);
              let featureArea = "";
              for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim() === '### Feature Area') {
                  for (let j = i + 1; j < lines.length; j++) {
                    const val = lines[j].trim();
                    if (val === '') continue;
                    if (val.startsWith('###')) break;
                    featureArea = val;
                    break;
                  }
                  break;
                }
              }

              const validAreas = ["Android", "iOS"];
              return validAreas.includes(featureArea) ? featureArea : "";
            } catch (error) {
              console.error(error);
              return "";
            }

      - name: Fetch label id for selected area
        id: fetch_label_id
        if: ${{ steps.get_selected_feature_area.outputs.result != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          AREA: ${{ steps.get_selected_feature_area.outputs.result }}
        run: |
          gh api graphql -F owner=$OWNER -F name=$REPO -F topic="$AREA"  -f query='
            query($owner: String!, $name: String!, $topic: String) {
              repository(owner: $owner, name: $name){
                labels(first: 1, query: $topic) {
                  edges {
                    node {
                      id
                      name
                    }
                  }
                }
              }
            }' > repository_label_data.json

          LABEL_ID=$(jq -r '.data.repository.labels.edges[0]?.node?.id // empty' repository_label_data.json)
          echo "LABEL_ID=$LABEL_ID" >> $GITHUB_ENV

      - name: Label the discussion
        if: ${{ steps.get_selected_feature_area.outputs.result != '' && env.LABEL_ID != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ github.event.discussion.node_id }}
        run: |
          gh api graphql -f query='
            mutation($labelableId: ID!, $labelIds: [ID!]!) {
              addLabelsToLabelable(input: {labelableId: $labelableId, labelIds: $labelIds}) {
                labelable {
                  labels(first: 10) {
                    edges {
                      node {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }' -f labelableId=$DISCUSSION_ID -f labelIds[]=$LABEL_ID
